import{g as te,aj as le,ak as C,Y as m,aa as v,h as V,i as ae,k as se,o as b,m as x,p as I,t as w,l as N,D as _,x as D,J as S,K as k,aq as ne,ap as oe,au as ie,ao as re,P as de,a8 as ce,c as P,a5 as ue,av as pe,aw as fe,ax as me}from"./vendor-a962175c.js";import{_ as Ie}from"./index.vue_vue_type_script_setup_true_lang-0d69b02f.js";import{h as _e,e as B,M as De,F as T,i as he,j as u}from"./index-11d2d6b3.js";import{a as be,g as ge,b as ye,c as ve,d as Te}from"./index-8a0f43b8.js";const Ee={class:"scrollBar-light"},Fe={class:"pt-[16px] pb-[16px] ml-[32px] flex items-center relative"},Ce={class:"min-w-[60px] h-4 font-semibold leading-4"},Ve={class:"min-w-[120px] h-4 font-normal leading-4 ml-[22px] text-regular"},xe={class:"flex items-center flex-wrap"},we=["onClick"],Pe=te({__name:"Add",setup(Oe){const j=ne(),f=oe(),R=_e(),{t:M}=le(),g=Number(f.query.projectId),O=Number(f.query.templateId),c=C({}),q=C([{label:"No",prop:"index",width:80,render:({$index:e})=>m("span",e+1)},{label:"公司",prop:"company",render:({row:e})=>m(v,{modelValue:e.company,onInput:t=>{e.company=t}})},{label:"部门",prop:"department",render:({row:e})=>m(v,{modelValue:e.department,onInput:t=>{e.department=t}})},{label:"设备号",prop:"tel",render:({row:e})=>m(v,{modelValue:e.tel,onInput:t=>{e.tel=t}})},{label:"座机号",prop:"landline",render:({row:e})=>m(v,{modelValue:e.landline,onInput:t=>{e.landline=t}})},{label:"",width:80,render:({$index:e})=>m(B,{class:"flex items-center cursor-pointer",iconClass:"EP_add_add",onClick:()=>{G(e)}})}]);let E=[];const i=V([]),F=V(!1),y=V([]),U=String(f.query.currentTitle),X=String(f.query.currentDesc),K=ae(()=>e=>e+": "),L=C([{company:"18",department:"New York",tel:"180 000 000 00",landline:"180 000 000 00"}]),G=e=>{L.splice(e+1,0,{company:"",department:"",tel:"",landline:""})},H=async()=>{F.value=!0;const e=await ge({ProjectID:g,TemplateID:O,OperationType:6});E=e.fields;const t=e.fields.find(l=>l.id===T.EVENT_TICKET);t&&t.dbValue&&typeof t.dbValue=="number"&&$(t.dbValue);let a=0;e.fields.map(l=>{l.id==T.CURRENT_STATUS&&(a=l.dbValue)}),a||(a=e.oldStatusID),Q(a)},$=async e=>{const t=await ye({projectId:g}),a=t.stmartIssueTypePages.filter(n=>n.incidentTypeID==e).map(n=>n.guiPageID),l=t.fieldsOnPage.filter(n=>a.includes(n.guiPageID));for(let n=0;n<l.length;n++){const r=l[n],o=t.customFields.find(s=>s.fieldID==r.uiFieldID),p=t.sysFields.find(s=>s.fieldID==r.uiFieldID),d=o||p;!p&&!o||(d.width=r.width,d.height=r.height,d.tabOrder=r.tabOrder,i.value=[...i.value,d])}i.value=pe(i.value,"fieldID"),i.value.sort((n,r)=>n.tabOrder-r.tabOrder),i.value=i.value.filter(n=>n.visibleToCustomer>he.HIDDEN),z()},z=async()=>{let e=[];const t=i.value.filter(l=>l.fieldTypeID===u.DROPDOWN_LIST||l.fieldTypeID===u.CHECKBOX||l.fieldTypeID===u.COMBOBOX||l.fieldTypeID===u.MULTIPLE_SELECTION_LISTBOX);t.forEach(l=>{e.push(ve(g,l.fieldID))});const a=await Promise.all(e);t.map((l,n)=>(l.listChoice=a[n],l)),i.value.forEach(l=>{const n=t.find(r=>r.fieldID===l.fieldID);n&&(l.listChoice=n.listChoice)}),W()},W=()=>{i.value.forEach(e=>{if((e.fieldTypeID===u.CHECKBOX||e.fieldTypeID===u.MULTIPLE_SELECTION_LISTBOX)&&e.fieldID!==T.DATA_GRID){const t=Y(e.fieldID);c[e.fieldID]=t}else if(e.fieldID===T.DATA_GRID)c[e.fieldID]=[];else{const t=J(e.fieldID,e.fieldTypeID);c[e.fieldID]=t}})},Y=e=>{const t=E.filter(a=>a.id===e);if(t.length){const a=[];return t.forEach(l=>{l.dbValue&&a.push(l.dbValue)}),a}else return[]},J=(e,t)=>{const a=E.find(l=>l.id===e);if(a){if(a.dbValue&&(t===u.COMBOBOX||t===u.DROPDOWN_LIST))return a.dbValue;{const l=a.value;return l||""}}else return""},Q=async e=>{const t=await Te({projectId:Number(f.query.projectId),crntStatusID:e});t.forEach(a=>a.selected=!1),y.value=t,F.value=!1},Z=e=>{y.value.forEach((t,a)=>{a===e?t.selected=!t.selected:t.selected=!1})},A=async()=>{const e=[],t=i.value.find(o=>o.fieldName==="标题");for(const o in c){const p=Number(o);if(p===(t==null?void 0:t.fieldID))continue;const d=c[o];let s;Array.isArray(d)?s=d.join(","):s=d;const h={FieldID:p,Value:s};e.push(h)}let a="";if(t){const o=c[t.fieldID];typeof o=="string"&&(a=o)}const l=y.value.find(o=>o.selected),n=l===void 0?0:l.transitionId;await be({ProjectID:g,TemplateID:O,OperationType:1,Name:a,LastTransitionID:n,Fields:e}),j.push({path:"/ep/event"}).then(()=>{R.addTagsViewList({title:M("layout.event_list"),name:"/ep/event",group:De.MODULE,meta:f.meta})})},ee=()=>{H()};return se(()=>{ee()}),(e,t)=>{const a=fe,l=Ie,n=me,r=ie,o=re,p=de,d=ce;return b(),x("div",Ee,[I("div",Fe,[I("span",Ce,w(N(U)),1),I("span",Ve,w(N(X)),1),I("span",{class:"min-w-[24px] h-4 font-normal leading-4 absolute right-[77px] cursor-pointer",onClick:A},"提交"),_(B,{iconClass:"EP_add_submit",className:"absolute right-[48px] cursor-pointer",size:"19",onClick:A})]),_(d,{class:"py-8 pr-16 pl-9 mx-8 enter-x",shadow:"hover"},{default:D(()=>[_(p,{animated:"",throttle:500,count:6,loading:F.value},{default:D(()=>[I("div",xe,[(b(!0),x(S,null,k(y.value,(s,h)=>(b(),P(a,{content:`目标状态“${s.nextStatusName}”`,placement:"top",key:s.statusId},{default:D(()=>[I("div",{class:ue(["mt-2 px-5 py-1 border-2 w-fit rounded mr-2 cursor-pointer",[s.nextStatusIfClosed>0?"border-[#FA6400] text-[#FA6400]":"border-theme text-theme",s.selected?"bg-[var(--el-color-primary)] text-[var(--el-color-white)]":"bg-default text-theme"]]),onClick:Le=>Z(h)},w(s.transitionName),11,we)]),_:2},1032,["content"]))),128))]),_(o,{class:"p-5",model:c,"label-width":100},{default:D(()=>[_(r,null,{default:D(()=>[(b(!0),x(S,null,k(i.value,s=>(b(),P(n,{key:s.uiFieldID,class:"flex justify-start",span:s.width==1?12:24},{default:D(()=>[_(l,{class:"text-secondary font-semibold text-[#505050] w-full items-center",modelValue:c[s.fieldID],"onUpdate:modelValue":h=>c[s.fieldID]=h,label:K.value(s.fieldName),fieldId:s.fieldID,attributes:s.attributes||{},fieldTypeId:s.fieldTypeID,"list-choice":s.listChoice,"table-columns":q,"table-data":L},null,8,["modelValue","onUpdate:modelValue","label","fieldId","attributes","fieldTypeId","list-choice","table-columns","table-data"])]),_:2},1032,["span"]))),128))]),_:1})]),_:1},8,["model"])]),_:1},8,["loading"])]),_:1})])}}});export{Pe as default};
